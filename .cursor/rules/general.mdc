---
description: StreamKeys Extension - General Development Notes
alwaysApply: true
---

# StreamKeys Extension Development Notes

## IMPORTANT: Cursor rules
This project uses cursor rules located under `.cursor/rules/*.mdc` and nested rules in `src/` folder for individual
modules. **Always check and update** relevant rule files after introducing changes, to make sure they contain relevant
information, and crucial rules for new code.

### Service-specific Rules
When the prompt mentions a specific streaming provider, **always load the corresponding rules**:
- **Disney+, Disney Plus, Disney** → `src/services/.cursor/rules/disney.mdc`
- **HBO Max, HBO, Max** → `src/services/.cursor/rules/hbomax.mdc`

These rules contain critical DOM selectors, Shadow DOM access patterns, and service-specific quirks that must be followed.

## IMPORTANT: Code Quality Requirements

**After ANY code change, you MUST run linters and fix all issues before the task is complete.**

Run `npm run check` to verify:
- TypeScript type checking (`npm run typecheck`)
- ESLint linting (`npm run lint`)
- Prettier formatting (`npm run format:check`)

A task is NOT complete until all checks pass. Use `npm run lint:fix` and `npm run format` to auto-fix issues.

## Project Structure

```
stream-keys/
├── src/
│   ├── background/          # Service worker
│   │   └── index.ts         # Routes to appropriate handler based on URL
│   ├── features/            # Composable feature modules
│   │   ├── restore-position/
│   │   ├── subtitles/
│   │   └── keyboard/
│   ├── ui/                  # UI utilities
│   │   ├── banner.ts
│   │   ├── overlay.ts
│   │   └── styles/
│   ├── core/                # Core utilities
│   │   ├── focus.ts
│   │   ├── fullscreen.ts
│   │   ├── player.ts
│   │   ├── video.ts
│   │   └── settings.ts
│   ├── handlers/            # Handler factory and types
│   │   ├── factory.ts       # createHandler() with feature composition
│   │   ├── index.ts         # Handler exports
│   │   └── types.ts         # Handler type definitions
│   ├── services/            # Service-specific implementations
│   │   ├── disney.ts        # Disney+ handler
│   │   └── hbomax.ts        # HBO Max handler
│   ├── settings/            # Options page
│   │   ├── index.ts
│   │   └── settings.css
│   └── types/               # Shared type definitions
│       └── index.ts
├── vite.config.ts           # Vite build configuration
├── tsconfig.json            # TypeScript configuration
└── manifest.json            # Extension manifest (old, kept for reference)
```

## Adding New Streaming Services

1. Create new service handler in `src/services/` folder (e.g., `netflix.ts`)
2. Use `createHandler(config)` with service-specific config and feature flags
3. Add URL matching in `src/background/index.ts` router
4. Add host permissions in `src/manifest.json`
5. Create service-specific Cursor rules file in `src/services/.cursor/rules/` (e.g., `netflix.mdc`)

## Handler Configuration with Feature Flags

Service handlers provide a config object to `createHandler()`:

```typescript
createHandler({
  name: 'Service Name',
  getPlayer: () => document.querySelector('.player'),
  getButton: (keyCode) => { /* return button for key */ },
  setupPlayerFocus: (player) => { /* optional: custom focus logic */ },
  onPlayerSetup: (player) => { /* optional: called on player setup */ },
  getOverlayContainer: () => { /* optional: container for click overlay */ },
  subtitles: {
    getAvailable: () => { /* return [{label, element, ...}] */ },
    getCurrentState: () => { /* return true if subtitles on */ },
    turnOff: () => { /* click off option */ },
    selectLanguage: (item) => { /* click language option */ }
  },
  // Feature flags (all true by default)
  features: {
    subtitles: true,
    restorePosition: true,
    keyboard: true,
    fullscreenOverlay: true
  }
});
```

## Settings & Storage

- Settings stored in `chrome.storage.sync` under keys:
  - `subtitleLanguages`: string[]
  - `positionHistoryEnabled`: boolean
- Default languages: `['English', 'English [CC]', 'English CC']`
- Settings injected as `window.__streamKeysSettings` before handlers load
- Access in handlers via `window.__streamKeysSettings`

## TypeScript Conventions

- Use strict mode
- Export types from `@/types`
- Use CSS variables from `@/ui/styles/variables`
- Prefer `const` assertions for configuration objects

## Logging Convention

- `console.info('[StreamKeys] ...')` - Extension loaded messages
- `console.warn('[StreamKeys] ...')` - Button not found or other recoverable issues

## Build Commands

- `npm run dev` - Watch mode for development
- `npm run build` - Production build (Chrome)
- `npm run build:firefox` - Firefox build (future)
- `npm run typecheck` - Type checking without emit
- `npm run lint` - Run ESLint
- `npm run lint:fix` - Run ESLint with auto-fix
- `npm run format` - Format code with Prettier
- `npm run format:check` - Check formatting without changes
- `npm run check` - Run all checks (typecheck + lint + format)

## Manifest Constraints

- The `description` field in `manifest.json` has a maximum length of 132 characters.
