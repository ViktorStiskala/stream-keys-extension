---
description: Testing patterns and conventions for StreamKeys extension using Vitest. Apply this rule when writing new tests, running npm test or npm run test:watch, working with DOM fixtures in resources/dom/, debugging test failures, or understanding the test infrastructure. Covers: co-located test files (*.test.ts next to source), the _test object pattern for exposing internals, fixture setup helpers (loadDOMFixture), and testing constants. Essential when creating tests in src/, modifying vitest.config.ts or vitest.setup.ts, or adding service-specific test files. Relevant keywords: test, vitest, spec, assertion, fixture, mock, DOM testing, test:watch, npm test.
globs:
  - "**/*.test.ts"
  - "**/vitest.*.ts"
  - "resources/dom/**"
alwaysApply: false
---

# Testing

## When to Run Tests

Run `npm test` after changes to source code in `src/` that could affect functionality. Tests are NOT required for:
- README or documentation updates
- Cursor rules changes
- Configuration files outside `src/`

## Test Commands

- `npm test` - Run all tests once
- `npm run test:watch` - Run tests in watch mode

## Test Structure

Tests are co-located with source files (vitest best practice):
- `src/core/video.test.ts` - Tests for `video.ts`
- `src/features/restore-position/history.test.ts` - Tests for position history
- `src/services/disney.test.ts` - Disney+ service tests
- `src/services/hbomax.test.ts` - HBO Max service tests
- `src/build.test.ts` - Production build verification

## DOM Fixtures

Real DOM snapshots for integration testing are stored in `resources/dom/`:
- `resources/dom/disney.html` - Disney+ player DOM snapshot
- `resources/dom/disney_full.html` - Disney+ fullscreen player snapshot
- `resources/dom/hbomax.html` - HBO Max player DOM snapshot
- `resources/dom/youtube.html` - YouTube player DOM snapshot
- `resources/dom/bbc.html` - BBC iPlayer player DOM snapshot

Use the test setup helpers from `vitest.setup.ts`:

```typescript
import { loadFixture, resetFixture } from '@test';

loadFixture('hbomax');   // From resources/dom/hbomax.html
loadFixture('disney');   // From resources/dom/disney.html
loadFixture('youtube');  // From resources/dom/youtube.html
loadFixture('bbc');      // From resources/dom/bbc.html

// Always reset in afterEach
afterEach(() => resetFixture());
```

## BBC Shadow DOM Helper

BBC iPlayer uses deeply nested Shadow DOM (4-5 levels). Use `createBBCShadowDOM()` to create the structure programmatically for testing:

```typescript
import { createBBCShadowDOM, type BBCShadowDOMElements } from '@test';

const elements = createBBCShadowDOM({ subtitlesOn: false });
// Returns:
// - toucan: smp-toucan-player element
// - videoLayout: smp-video-layout element
// - video: HTMLVideoElement
// - playPauseButton: HTMLButtonElement
// - fullscreenButton: HTMLButtonElement
// - backwardButton: HTMLButtonElement
// - forwardButton: HTMLButtonElement
// - subtitleToggle: HTMLElement (.toggle div)
// - setSubtitlesOn(on: boolean): Toggle subtitle state
```

This helper creates the full nested shadow DOM structure that BBC iPlayer uses, allowing tests to verify selector traversal and button access without needing the actual DOM fixture.

## Service Testing Pattern

Services export a `_test` object with internal functions for testing:

Export `_test` object with internal functions for testing (e.g., `getPlayer`, `getVideo`, `subtitles`).

See `.cursor/rules/scripts/testing/service-test-pattern.ts` for the template.

## Testing Constants

When testing with threshold values, import and use the exported constants instead of hardcoding:

Import threshold constants from source (`SEEK_MIN_DIFF_SECONDS`, etc.) instead of hardcoding in tests.

See `.cursor/rules/scripts/testing/testing-constants.ts` for the template.

## Fixture Setup Pattern

Test setup pattern: `resetFixture()` + `loadFixture('service')` in `beforeEach`.

See `.cursor/rules/scripts/testing/fixture-setup.ts` for the template.

## Writing New Tests

When adding new functionality:
1. Create a `.test.ts` file next to the source file
2. Use descriptive test names that explain the expected behavior
3. Import constants for threshold values instead of hardcoding
4. Use DOM fixtures for integration tests when testing DOM interactions
5. Export internal functions via `_test` object if needed for testing
