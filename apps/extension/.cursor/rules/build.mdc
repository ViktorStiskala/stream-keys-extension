---
description: Build commands and development workflow for the StreamKeys browser extension. Apply this rule when running npm scripts (dev, build, typecheck, lint, format), creating development or production builds, targeting different browsers (Chrome, Firefox, Safari), configuring the BROWSER environment variable, troubleshooting build output directories (build/dev/, build/production/), dealing with multi-browser compilation issues, or working with Safari DMG builds. Relevant keywords: npm run dev, npm run build, vite, webpack, bundle, compile, production, development mode, safari, dmg, dmgbuild, notarize, uv, python.
globs:
  - "vite.config.ts"
  - "package.json"
  - "tsconfig.json"
  - "scripts/build-safari/**"
alwaysApply: false
---

# Build Commands

## Development

- `npm run dev` - Watch mode for development (Chrome by default)
- `BROWSER=firefox npm run dev` - Firefox dev mode

## Production

- `npm run build` - Production build (Chrome by default)
- `npm run build:firefox` - Firefox build

## Safari Builds

Safari builds use a Python-based build tool in `scripts/build-safari/` with Textual TUI:

- `npm run build:safari` - Local testing DMG (ad-hoc signed, not notarized)
- `npm run build:safari:signed` - Distribution DMG (signed + notarized)
- `npm run build:safari:appstore` - App Store package

### Build Script Structure (Python)

```
scripts/build-safari/
├── pyproject.toml           # uv project config with dependencies and [tool.build-safari] config
├── dmg_settings.py          # dmgbuild configuration
├── entitlements/            # App and extension entitlements
│   ├── app.entitlements
│   └── extension.entitlements
└── src/build_safari/
    ├── __main__.py          # Entry point
    ├── cli.py               # argparse argument parsing
    ├── config.py            # Configuration dataclasses (loads from pyproject.toml + .env)
    ├── runner.py            # Build orchestration
    ├── steps/               # Individual build steps
    │   ├── base.py          # Abstract BuildStep class
    │   ├── vite.py          # ViteBuildStep
    │   ├── xcode.py         # XcodeConvertStep, XcodeBuildStep
    │   ├── signing.py       # SigningVerifyStep
    │   ├── dmg.py           # DMGCreateStep (uses dmgbuild)
    │   ├── notarize.py      # NotarizeStep, StapleStep
    │   └── appstore.py      # AppStorePackageStep
    ├── ui/                  # User interface
    │   ├── app.py           # Textual TUI with terminal restoration
    │   ├── simple.py        # Simple colored output for --simple mode
    │   └── protocol.py      # BuildUI protocol
    └── utils/
        ├── process.py       # Async subprocess runner with PTY for colors
        └── terminal.py      # OutputProcessor for TUI mode
```

### Build Script Options

```bash
# Direct invocation (uses uv to manage Python environment)
uv run --directory scripts/build-safari python -m build_safari --help

# Local testing (no signing credentials needed)
npm run build:safari
# or: uv run --directory scripts/build-safari python -m build_safari --dmg

# Distribution (requires APPLE_DEVELOPER_NAME, APPLE_TEAM_ID, APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD)
npm run build:safari:signed
# or: uv run --directory scripts/build-safari python -m build_safari --dmg --signed

# Rebuild DMG from existing production build (skips Vite, Xcode conversion, Xcode build)
uv run --directory scripts/build-safari python -m build_safari --rebuild-dmg           # unsigned
uv run --directory scripts/build-safari python -m build_safari --rebuild-dmg --signed  # signed + notarized

# App Store (requires APPLE_DEVELOPER_NAME, APPLE_TEAM_ID)
npm run build:safari:appstore
# or: uv run --directory scripts/build-safari python -m build_safari --appstore

# Simple output mode (disables TUI, useful for debugging or CI)
uv run --directory scripts/build-safari python -m build_safari --dmg --simple
```

The `--rebuild-dmg` option is useful when you need to regenerate the DMG without rebuilding the entire app. It validates that the existing build exists and has a valid signature (if --signed).

### Configuration

**App metadata** is in `scripts/build-safari/pyproject.toml` under `[tool.build-safari]`:
- App name, bundle ID
- Build paths
- DMG settings (icon positions, window size, background)

**Developer credentials** are in `.env` file (copy from `.env.example`):
- `APPLE_DEVELOPER_NAME` - Name as it appears in Apple certificates
- `APPLE_TEAM_ID` - Your 10-character Team ID
- `APPLE_ID` - Apple ID email for notarization
- `APPLE_APP_SPECIFIC_PASSWORD` - App-specific password

### Styled DMG Installer

Safari DMGs are created with `dmgbuild` (Python) using a custom background image showing:
- Stream Keys app icon on the left
- Arrow graphic pointing to Applications folder
- Applications folder shortcut for drag-and-drop installation

Configuration: `scripts/build-safari/dmg_settings.py` and `[tool.build-safari.dmg]` in pyproject.toml
Background: `assets/dmg-background.png` (660x480px window)

### Live Progress Display (Textual TUI)

In TTY mode, the build shows a rich terminal interface with:
- Fixed header with build description
- Step progress table with status indicators
- Scrolling output log with preserved ANSI colors (via PTY)
- Real-time waiting indicator when commands produce no output

When the TUI exits, the terminal is restored with the full build log in scrollback history.

Use `--simple` flag to disable TUI and use simple colored output instead.

Falls back to simple output automatically in CI environments (non-TTY).

## Code Quality

- `npm run typecheck` - Type checking without emit
- `npm run lint` - Run ESLint
- `npm run lint:fix` - Run ESLint with auto-fix
- `npm run format` - Format code with Prettier
- `npm run format:check` - Check formatting without changes
- `npm run check` - Run all checks (typecheck + lint + format)

## Multi-Browser Builds

Set `BROWSER` environment variable to target different browsers:
- `chrome` (default) - Chromium-based browsers (Chrome, Edge, Brave)
- `firefox` - Firefox desktop
- `safari` - Safari (macOS only, use build:safari scripts)

Output directories:
- Dev: `build/dev/{browser}/extension`
- Prod: `build/production/{browser}/extension`
- Safari DMG: `build/production/safari/stream-keys-safari.dmg`

## Browser-Specific Manifest Transformations

The `vite.config.ts` transforms the manifest for browser compatibility:

### Background Script Format

- **Chrome**: Uses `service_worker` (Manifest V3 standard)
- **Firefox/Safari**: Uses `scripts` array (these browsers don't support service workers in extensions)

```json
// Chrome
"background": { "service_worker": "src/background/index.js" }

// Firefox & Safari
"background": { "scripts": ["src/background/index.js"] }
```

### Main World Injection (Safari Compatibility)

Safari doesn't support `world: "MAIN"` in:
- `manifest.json` content_scripts
- `browser.scripting.executeScript()`

**Solution**: Use script tag injection instead. See the handlers.mdc rule for details on the shadow patcher loader pattern.
